Description: Query each keyboard-interactive device only once per auth request
Author: Damien Miller <djm@openbsd.org>
Origin: https://anongit.mindrot.org/openssh.git/patch/?id=5b64f85bb811246c59ebab
Abstract:
 Query each keyboard-interactive device only once per authentication request
 regardless of how many times it is listed.
 .
 This fixes CVE-2015-5600.
 .
 Backport to openSSH 5.5p1 by Mike Gabriel <mike.gabriel@das-netzwerkteam.de>

--- a/auth2-chall.c
+++ b/auth2-chall.c
@@ -82,6 +82,7 @@
 	void *ctxt;
 	KbdintDevice *device;
 	u_int nreq;
+	u_int devices_done;
 };
 
 #ifdef USE_PAM
@@ -169,9 +170,15 @@
 
 		if (len == 0)
 			break;
-		for (i = 0; devices[i]; i++)
-			if (strncmp(kbdintctxt->devices, devices[i]->name, len) == 0)
+		for (i = 0; devices[i]; i++) {
+			if ((kbdintctxt->devices_done & (1 << i)) != 0)
+			        continue;
+			if (strncmp(kbdintctxt->devices, devices[i]->name,
+			    len) == 0) {
 				kbdintctxt->device = devices[i];
+				kbdintctxt->devices_done |= 1 << i;
+			}
+		}
 		t = kbdintctxt->devices;
 		kbdintctxt->devices = t[len] ? xstrdup(t+len+1) : NULL;
 		xfree(t);
